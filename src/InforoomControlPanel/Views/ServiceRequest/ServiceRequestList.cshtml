@using System.Collections.Specialized
@using Common.Tools
@using Inforoom2.Components 
@using Inforoom2.Helpers
@using Inforoom2.Models
@model dynamic

@{
	ViewBag.Title = "Список сервисных заявок";
	Layout = "~/Views/Shared/_Layout.cshtml";
	ModelFilter<ServiceRequest> modelFilter = ViewBag.pager;
	var serviceRequests = modelFilter.GetItems();

	List<Region> regions = ViewBag.Regions;
	List<ServiceMan> serviceMen = ViewBag.ServiceMan;
	var regionList = new NameValueCollection();
	var serviceMenList = new NameValueCollection();
	var serviceRequestStatusList = new NameValueCollection();

	regionList["0"] = " ";
	regions.Each(i => regionList[i.Id.ToString()] = i.Name.ToString());
	serviceMenList["0"] = " ";
	serviceMen.Each(i => serviceMenList[i.Id.ToString()] = i.Employee.Name.ToString());
	serviceRequestStatusList["1"] = "Новая";
	serviceRequestStatusList["3"] = "Закрыта";
	serviceRequestStatusList["5"] = "Отменена";
	var datePeriodTypeList = new NameValueCollection();
	datePeriodTypeList["CreationDate"] = "Создания";
	datePeriodTypeList["BeginTime"] = "Назначения";
	datePeriodTypeList["ClosedDate"] = "Закрытия";
	datePeriodTypeList["ModificationDate"] = "Изменения";
}

<panel class="panel panel-default">
	<form>
		<div class="row">
			<div class="col-sm-1">Статус заявки</div>
			<div class="col-sm-2">@modelFilter.FormFilterManual("ServiceRequestStatus", HtmlType.Dropdown, serviceRequestStatusList)</div>
		</div>
		<div class="row">
			<div class="col-sm-1">Дата</div>
			<div class="col-sm-2">@modelFilter.FormFilterManual("DataFilter", HtmlType.Dropdown, datePeriodTypeList)</div>
		</div>
		<div class="row">
			<div class="col-sm-1">Интервал даты с </div>
			<div class="col-sm-2">@modelFilter.FormFilterManual("RequestFilterFrom", HtmlType.Date, SystemTime.Now().AddMonths(-1).Date)</div>
			<div class="col-sm-1">по</div>
			<div class="col-sm-2">@modelFilter.FormFilterManual("RequestFilterTill", HtmlType.Date, SystemTime.Now().AddDays(1).Date)</div>
		</div>
		<div class="row">
			<div class="col-sm-1"><label class="c-pointer" style="margin-bottom: 12px;" for="filterFree" >Бесплатные</label></div>
			<div class="col-sm-2">@modelFilter.FormFilterManual("FreeFilter", HtmlType.Checkbox, "id='filterFree'")</div>
		</div>
		<div class="row">
			<div class="col-sm-1">Назначена на</div>
			<div class="col-sm-2">@modelFilter.FormFilterManual("ServiceMenFilter", HtmlType.Dropdown, serviceMenList)</div>
		</div>
		<div class="row">
			<div class="col-sm-1">Регион</div>
			<div class="col-sm-2">@modelFilter.FormFilterManual("RegionFilter", HtmlType.Dropdown, regionList)</div>
		</div>
		<div class="row">
			<div class="col-sm-1">Поисковая фраза</div>
			<div class="col-sm-2">@modelFilter.FormFilterManual("TextSearch", HtmlType.text)</div>
		</div>
		<div class="row">
			<div class="col-sm-1">
				@modelFilter.FormFilterSubmit()
			</div>
			<div class="col-sm-2">
				<a style="top: 8px;position: relative;" href="@Url.Action("ServiceRequestList")">Полный список</a>
			</div>
		</div>  
	</form>
</panel>
<div id="table-2_wrapper" class="dataTables_wrapper form-inline no-footer"> 
	<table id="table-2" class="table table-bordered table-striped datatable dataTable no-footer" role="grid" aria-describedby="table-2_info">
		<thead>
			<tr role="row"> 
				<th class="sorting" tabindex="0" aria-controls="table-2"><a href="@modelFilter.OrderBy(s => s.Id)">Номер</a></th>
				<th class="sorting" tabindex="0" aria-controls="table-2"><a href="@modelFilter.OrderBy(s => s.Client.Id)">ЛС</a></th>
				<th class="sorting" tabindex="0" aria-controls="table-2"><a href="@modelFilter.OrderBy(s => s.Client.PhysicalClient.Name)">Клиент</a></th>
				<th class="sorting" tabindex="0" aria-controls="table-2">Краткое описание</th>
				<th class="sorting" tabindex="0" aria-controls="table-2"><a href="@modelFilter.OrderBy(s => s.Phone)">Контакт</a></th>
				<th class="sorting" tabindex="0" aria-controls="table-2"><a href="@modelFilter.OrderBy(s => s.CreationDate)">Создана</a></th>
				<th class="sorting" tabindex="0" aria-controls="table-2"><a href="@modelFilter.OrderBy(s => s.PerformanceDate)">Выполнена</a></th>
				<th class="sorting" tabindex="0" aria-controls="table-2"><a href="@modelFilter.OrderBy(s => s.ModificationDate)">Изменена</a></th>
				<th class="sorting" tabindex="0" aria-controls="table-2"><a href="@modelFilter.OrderBy(s => s.CreationDate)">Стоимость (руб.)</a></th>
				<th class="sorting" tabindex="0" aria-controls="table-2"><a href="@modelFilter.OrderBy(s => s.Status)">Статус</a></th>
				<th class="sorting" tabindex="0" aria-controls="table-2">Назначена на</th>
				<th class="sorting" tabindex="0" aria-controls="table-2">Дата назначения</th>
				<th class="sorting" tabindex="0" aria-controls="table-2">Действие</th>
			</tr>
		</thead>
		<tbody>
			@foreach (var request in serviceRequests) {
				<tr role="row" class="odd"> 
					<td><a href="@Url.Action("ServiceRequestEdit", "ServiceRequest", new { id = request.Id })">@request.Id</a></td>
					<td><a href="@(ConfigHelper.GetParam("adminPanelOld") + "UserInfo/ShowPhysicalClient?filter.ClientCode=" + request.Client.Id)">@request.Client.Id</a></td>
					<td>@request.Client.PhysicalClient.FullName</td>
					<td>@(request.Description.Length > 100 ? request.Description.Substring(0, 100) + "..." : request.Description)</td>
					<td>@request.Phone</td>
					<td>@request.CreationDate</td>
					<td>@request.ClosedDate</td>
					<td>@request.ModificationDate</td>
					<td>@(request.Sum.HasValue ? Decimal.Round(request.Sum.Value, 2).ToString() : "")</td>
					<td>@request.Status.GetDescription()</td>  
					<td>@(request.ServicemenScheduleItem != null && request.ServicemenScheduleItem.ServiceMan != null? request.ServicemenScheduleItem.ServiceMan.Employee.Name : "")</td> 
					<td>@(request.ServicemenScheduleItem != null && request.ServicemenScheduleItem.BeginTime.HasValue ? request.ServicemenScheduleItem.BeginTime.Value.ToString("dd.MM.yyyy HH.mm.ss") : "")</td> 
					<td>
						<a class="btn btn-success btn-sm btn-icon icon-left" href="@Url.Action("ServiceRequestEdit", "ServiceRequest", new { id = request.Id })">
							<i class="entypo-doc-text"></i>
							Изменить
						</a>
					</td>
				</tr>
			}
		</tbody>
	</table>
	<div class="row">
		@{ Html.RenderPartial("Pagination"); }
	</div>
</div>